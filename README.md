# queue-sample
Sample AMQP queue consumer for fast, in-order processing using Redis.
Contains producer and consumer parts.

Producer part generates messages to AMQP queue.

Consumer part reads the messages. Should be started in several instances to process messages as fast as possible. Redis used to order received messages and ensure processing in order. 

# Fast start
Go to **fast-start** folder and start pre-built version:

    cd ./fast-start
    docker compose up --scale consumer=10

Stop with Ctrl-C, it will gracefully stop after 3 seconds. Don't forget to turn it off:

    docker compose down

# Configuration
You can set parameters using environment variables:
* RABBIT_URI - full amqp URI (default: amqp://localhost )
* MAX_RETRY - retry count for unexpected errors (default: 5)
* REDIS_HOST - host for redis, other by default (default: localhost )
  
Generation parameters:
* EVENT_COUNT - count of events, generated by producer (default: 10000)
* USER_COUNT - count of distinct users (default: 1000)
* BATCH_SIZE - max batch size for one user (default: 11)

# Local start in docker
Build or rebuild the image, from project root folder:

    docker compose build

Start with RabbitMQ and Redis at once:

    docker compose up --scale consumer=10


# Local development
Install NodeJS v14. Install required modules:

    npm i

Start RabbitMQ and Redis (local or in docker). Start producer, then consumer:

    npm run produce
    npm run consume

